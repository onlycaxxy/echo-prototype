/* VIE 2.1.0 may be freely distributed under the MIT license. See http://viejs.org/ for more details. */(function(){var a=this,d=a.jQuery,e=a.Backbone,b=a._;var c=a.VIE=function(f){this.config=(f)?f:{};this.services={};this.jQuery=d;this.entities=new this.Collection([],{vie:this});this.Entity.prototype.entities=this.entities;this.Entity.prototype.entityCollection=this.Collection;this.Entity.prototype.vie=this;this.Namespaces.prototype.vie=this;this.namespaces=new this.Namespaces((this.config.baseNamespace)?this.config.baseNamespace:"http://viejs.org/ns/",{owl:"http://www.w3.org/2002/07/owl#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",schema:"http://schema.org/",foaf:"http://xmlns.com/foaf/0.1/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#",dbpedia:"http://dbpedia.org/ontology/",dbprop:"http://dbpedia.org/property/",skos:"http://www.w3.org/2004/02/skos/core#",xsd:"http://www.w3.org/2001/XMLSchema#",sioc:"http://rdfs.org/sioc/ns#",dcterms:"http://purl.org/dc/terms/"});this.Type.prototype.vie=this;this.Types.prototype.vie=this;this.Attribute.prototype.vie=this;this.Attributes.prototype.vie=this;this.types=new this.Types();this.types.add("owl:Thing");if(this.config.classic===true){this.RDFa=new this.ClassicRDFa(this);this.RDFaEntities=new this.ClassicRDFaEntities(this);this.EntityManager=new this.ClassicEntityManager(this);this.cleanup=function(){this.entities.reset()}}};c.prototype.use=function(f,g){if(!g&&!f.name){throw new Error("Please provide a name for the service!")}f.vie=this;f.name=(g)?g:f.name;if(f.init){f.init()}this.services[f.name]=f;return this};c.prototype.service=function(f){if(!this.hasService(f)){throw"Undefined service "+f}return this.services[f]};c.prototype.hasService=function(f){if(!this.services[f]){return false}return true};c.prototype.getServicesArray=function(){return b.map(this.services,function(f){return f})};c.prototype.load=function(f){if(!f){f={}}f.vie=this;return new this.Loadable(f)};c.prototype.save=function(f){if(!f){f={}}f.vie=this;return new this.Savable(f)};c.prototype.remove=function(f){if(!f){f={}}f.vie=this;return new this.Removable(f)};c.prototype.analyze=function(f){if(!f){f={}}f.vie=this;return new this.Analyzable(f)};c.prototype.find=function(f){if(!f){f={}}f.vie=this;return new this.Findable(f)};c.prototype.loadSchema=function(g,f){f=(!f)?{}:f;if(!g){throw new Error("Please provide a proper URL")}else{var h=this;d.getJSON(g).success(function(i){try{c.Util.loadSchemaOrg(h,i,f.baseNS);if(f.success){f.success.call(h)}}catch(j){f.error.call(h,j);return}}).error(function(j,k,i){if(f.error){console.warn(j,k,i);f.error.call(h,"Could not load schema from URL ("+g+")")}})}return this};c.prototype.getTypedEntityClass=function(h){var g=this.types.get(h);if(!g){throw new Error("Unknown type "+h)}var f=function(i,j){if(!i){i={}}i["@type"]=h;this.set(i,j)};f.prototype=new this.Entity();f.prototype.schema=function(){return c.Util.getFormSchemaForType(g)};return f};if(typeof exports==="object"){exports.VIE=c;if(!d){d=require("jquery")}if(!e){e=require("backbone");e.setDomLibrary(d)}if(!b){b=require("underscore")._}}c.prototype.Able=function(){this.init=function(g,f){this.options=g;this.services=g.from||g.using||g.to||[];this.vie=g.vie;this.methodName=f;this.deferred=d.Deferred();this.resolve=this.deferred.resolve;this.resolveWith=this.deferred.resolveWith;this.reject=this.deferred.reject;this.rejectWith=this.deferred.rejectWith;this.success=this.done=this.deferred.done;this.fail=this.deferred.fail;this.then=this.deferred.then;this.always=this.deferred.always;this.from=this.using;this.to=this.using;return this};this.using=function(g){var f=this;g=(b.isArray(g))?g:[g];b.each(g,function(h){var i=(typeof h==="string")?f.vie.service(h):h;f.services.push(i)});return this};this.execute=function(){var f=this;b(this.services).each(function(g){g[f.methodName](f)});return this}};c.prototype.Loadable=function(f){this.init(f,"load")};c.prototype.Loadable.prototype=new c.prototype.Able();c.prototype.Savable=function(f){this.init(f,"save")};c.prototype.Savable.prototype=new c.prototype.Able();c.prototype.Removable=function(f){this.init(f,"remove")};c.prototype.Removable.prototype=new c.prototype.Able();c.prototype.Analyzable=function(f){this.init(f,"analyze")};c.prototype.Analyzable.prototype=new c.prototype.Able();c.prototype.Findable=function(f){this.init(f,"find")};c.prototype.Findable.prototype=new c.prototype.Able();c.Util={toCurie:function(g,j,i){if(c.Util.isCurie(g,i)){return g}var l=":";for(var f in i.toObj()){if(g.indexOf(i.get(f))===1){var h=new RegExp("^<?"+i.get(f));if(f===""){l=""}return((j)?"[":"")+g.replace(h,f+l).replace(/>$/,"")+((j)?"]":"")}}throw new Error("No prefix found for URI '"+g+"'!")},isCurie:function(f,g){if(c.Util.isUri(f)){return false}else{try{c.Util.toUri(f,g);return true}catch(h){return false}}},toUri:function(f,i){if(c.Util.isUri(f)){return f}var j=":";for(var h in i.toObj()){if(h!==""&&(f.indexOf(h+":")===0||f.indexOf("["+h+":")===0)){var g=new RegExp("^\\[{0,1}"+h+j);return"<"+f.replace(g,i.get(h)).replace(/\]{0,1}$/,"")+">"}}if(f.indexOf(j)===-1){return"<"+i.base()+f+">"}throw new Error("No prefix found for CURIE '"+f+"'!")},isUri:function(f){return(typeof f==="string"&&f.search(/^<.+>$/)===0)},mapAttributeNS:function(f,h){var g=f;if(h.isUri(f)||f.indexOf("@")===0){}else{if(h.isCurie(f)){g=h.uri(f)}else{if(!h.isUri(f)){if(f.indexOf(":")===-1){g="<"+h.base()+f+">"}else{g="<"+f+">"}}}}return g},rdf2Entities:function(m,g){if(typeof d.rdf!=="function"){return c.Util._rdf2EntitiesNoRdfQuery(m,g)}try{var l=(g instanceof d.rdf)?g.base(m.vie.namespaces.base()):d.rdf().base(m.vie.namespaces.base()).load(g,{});if(m.rules){var p=d.rdf.ruleset();for(var j in m.vie.namespaces.toObj()){if(j!==""){p.prefix(j,m.vie.namespaces.get(j))}}for(var h=0;h<m.rules.length;h++){if(m.rules.hasOwnProperty(h)){var o=m.rules[h];p.add(o.left,o.right)}}l=l.reason(p,10)}var k={};l.where("?subject ?property ?object").each(function(){var q=this.subject.toString();if(!k[q]){k[q]={"@subject":q,"@context":m.vie.namespaces.toObj(true),"@type":[]}}var s=this.property.toString();var t;try{t=m.vie.namespaces.curie(s)}catch(r){t=s}k[q][t]=k[q][t]||[];function i(u){if(typeof u.value==="string"){if(u.lang){var v={toString:function(){return this["@value"]},"@value":u.value.replace(/^"|"$/g,""),"@language":u.lang};return v}else{return u.value}return u.value.toString()}else{if(u.type==="uri"){return u.toString()}else{return u.value}}}k[q][t].push(i(this.object))});b(k).each(function(i){i["@type"]=i["@type"].concat(i["rdf:type"]);delete i["rdf:type"];b(i).each(function(r,q){if(r.length===1){i[q]=r[0]}})});var f=[];d.each(k,function(){var i=new m.vie.Entity(this);i=m.vie.entities.addOrUpdate(i);f.push(i)});return f}catch(n){console.warn("Something went wrong while parsing the returned results!",n);return[]}},getPreferredLangForPreferredProperty:function(k,q,i){var j,t,h,g,s,o,n,r,f,m=this;o=[];b.each(i,function(l){b.each(q,function(p){t=null;if(typeof p==="string"&&k.get(p)){t=b.flatten([k.get(p)]);b(t).each(function(u){var v,x,w;x=g;v=u["@language"];if(typeof u==="string"&&(u.indexOf("@")===u.length-3||u.indexOf("@")===u.length-5)){v=u.replace(/(^\"*|\"*@)..(..)?$/g,"")}if(v){if(v===l){x+=j}else{x+=20}}else{x+=10}w=u.toString();w=w.replace(/(^\"*|\"*@..$)/g,"");return o.push({score:x,value:w})})}else{if(typeof p==="object"&&k.get(p.property)){n=b.flatten([k.get(p.property)]);n=b(n).map(function(u){if(u.isEntity){return u.getSubject()}else{return u}});o.push({score:g,value:p.makeLabel(n)})}}})});o=b(o).sortBy(function(l){return l.score});if(o.length){return o[0].value}else{return"n/a"}},_rdf2EntitiesNoRdfQuery:function(f,g){var h=[];b.forEach(g,function(k,j){var i={};i["@subject"]="<"+j+">";b.forEach(k,function(m,l){l="<"+l+">";b.forEach(m,function(n){if(n.type==="uri"){n.value="<"+n.value+">"}if(i[l]&&!b.isArray(i[l])){i[l]=[i[l]]}if(b.isArray(i[l])){i[l].push(n.value);return}i[l]=n.value})});h.push(i)});return h},loadSchemaOrg:function(n,k,o){if(!k){throw new Error("Please load the schema.json file.")}n.types.remove("<http://schema.org/Thing>");var h=(o)?o:n.namespaces.base();n.namespaces.base(o);var i={DataType:"xsd:anyType",Boolean:"xsd:boolean",Date:"xsd:date",DateTime:"xsd:dateTime",Time:"xsd:time",Float:"xsd:float",Integer:"xsd:integer",Number:"xsd:anySimpleType",Text:"xsd:string",URL:"xsd:anyURI"};var j=function(t,u){var s=n.types.add(u,[{id:"value",range:i[u]}]);for(var r=0;r<t.length;r++){var q=(n.types.get(t[r]))?n.types.get(t[r]):j.call(n,k.datatypes[t[r]].supertypes,t[r]);s.inherit(q)}return s};for(var g in k.datatypes){if(!n.types.get(g)){var p=k.datatypes[g].supertypes;j.call(n,p,g)}}var m=function(r){var q={};if(r.label){q.label=r.label}if(r.url){q.url=r.url}if(r.comment){q.comment=r.comment}if(r.metadata){q=b.extend(q,r.metadata)}return q};var l=function(r){var q=[];b.each(k.types[r].specific_properties,function(s){var t=k.properties[s];q.push({id:t.id,range:t.ranges,min:t.min,max:t.max,metadata:m(t)})});return q};var f=function(v,w,u,s){var t=n.types.add(w,u,s);for(var r=0;r<v.length;r++){var q=(n.types.get(v[r]))?n.types.get(v[r]):f.call(n,k.types[v[r]].supertypes,v[r],l.call(n,v[r]),m(k.types[v[r]]));t.inherit(q)}if(w==="Thing"&&!t.isof("owl:Thing")){t.inherit("owl:Thing")}return t};b.each(k.types,function(s){if(n.types.get(s.id)){return}var r=s.supertypes;var q=m(s);f.call(n,r,s.id,l.call(n,s.id),q)});n.namespaces.base(h)},getEntityTypeUnion:function(f){var g=f.vie;return new g.Type("Union").inherit(f.get("@type"))},getFormSchemaForType:function(g,f){var h={};b.each(g.attributes.toArray(),function(j){var i=c.Util.toCurie(j.id,false,j.vie.namespaces);h[i]=c.Util.getFormSchemaForAttribute(j)});b.each(h,function(i,j){if(!i.type){delete h[j]}if(i.type==="URL"){i.type="Text";i.dataType="url"}if(i.type==="List"&&!i.listType){delete h[j]}if(!f){if(i.type==="NestedModel"||i.listType==="NestedModel"){delete h[j]}}});return h},getFormSchemaForAttribute:function(h){var f=h.range[0];var g={};var i=function(k){switch(k){case"xsd:anySimpleType":case"xsd:float":case"xsd:integer":return"Number";case"xsd:string":return"Text";case"xsd:date":return"Date";case"xsd:dateTime":return"DateTime";case"xsd:boolean":return"Checkbox";case"xsd:anyURI":return"URL";default:var j=h.vie.types.get(k);if(!j){return null}if(j.attributes.get("value")){return i(j.attributes.get("value").range[0])}return"NestedModel"}};g.title=c.Util.toCurie(h.id,false,h.vie.namespaces);if(h.min>0){g.validators=["required"]}if(h.max>1){g.type="List";g.listType=i(f);if(g.listType==="NestedModel"){g.nestedModelType=f}return g}g.type=i(f);if(g.type==="NestedModel"){g.nestedModelType=f}return g},getFormSchema:function(g){if(!g||!g.isEntity){return{}}var f=c.Util.getEntityTypeUnion(g);var h=c.Util.getFormSchemaForType(f,true);b.each(h,function(i,j){if(i.type!=="NestedModel"&&i.listType!=="NestedModel"){return}h[j].model=g.vie.getTypedEntityClass(i.nestedModelType)});return h},xsdDateTime:function(g){function l(p){var o=p.toString();return o.length<2?"0"+o:o}var m=g.getFullYear();var k=l(g.getMonth()+1);var f=l(g.getDate());var i=l(g.getHours());var j=l(g.getMinutes());var h=l(g.getSeconds());return m+"-"+k+"-"+f+"T"+i+":"+j+":"+h},extractLanguageString:function(o,s,m){var g,r,f,q,j;if(o&&typeof o!=="string"){s=(b.isArray(s))?s:[s];m=(b.isArray(m))?m:[m];for(g=0;g<s.length;g++){for(var k=0;k<m.length;k++){var h=m[k];r=s[g];if(o.has(r)){f=o.get(r);f=(b.isArray(f))?f:[f];for(q=0;q<f.length;q++){j=f[q];if(j.isEntity){j=c.Util.extractLanguageString(j,s,h)}else{if(typeof j==="string"){j=j}else{j=""}}if(j&&j.indexOf("@"+h)>-1){return j.replace(/"/g,"").replace(/@[a-z]+/,"").trim()}}}}}for(g=0;g<s.length;g++){r=s[g];if(o.has(r)){f=o.get(r);f=(b.isArray(f))?f:[f];for(q=0;q<f.length;q++){j=f[q];if(j.isEntity){j=c.Util.extractLanguageString(j,s,[])}if(j&&(typeof j==="string")&&j.indexOf("@")===-1){return j.replace(/"/g,"").replace(/@[a-z]+/,"").trim()}}}}}return undefined},transformationRules:function(f){var g=[{left:["?subject a dbpedia:Person","?subject rdfs:label ?label"],right:function(h){return function(){return[d.rdf.triple(this.subject.toString(),"a","<"+h.base()+"Person>",{namespaces:h.toObj()}),d.rdf.triple(this.subject.toString(),"<"+h.base()+"name>",this.label,{namespaces:h.toObj()})]}}(f.vie.namespaces)},{left:["?subject a foaf:Person","?subject rdfs:label ?label"],right:function(h){return function(){return[d.rdf.triple(this.subject.toString(),"a","<"+h.base()+"Person>",{namespaces:h.toObj()}),d.rdf.triple(this.subject.toString(),"<"+h.base()+"name>",this.label,{namespaces:h.toObj()})]}}(f.vie.namespaces)},{left:["?subject a dbpedia:Place","?subject rdfs:label ?label"],right:function(h){return function(){return[d.rdf.triple(this.subject.toString(),"a","<"+h.base()+"Place>",{namespaces:h.toObj()}),d.rdf.triple(this.subject.toString(),"<"+h.base()+"name>",this.label.toString(),{namespaces:h.toObj()})]}}(f.vie.namespaces)},{left:["?subject a dbpedia:City","?subject rdfs:label ?label","?subject dbpedia:abstract ?abs","?subject dbpedia:country ?country"],right:function(h){return function(){return[d.rdf.triple(this.subject.toString(),"a","<"+h.base()+"City>",{namespaces:h.toObj()}),d.rdf.triple(this.subject.toString(),"<"+h.base()+"name>",this.label.toString(),{namespaces:h.toObj()}),d.rdf.triple(this.subject.toString(),"<"+h.base()+"description>",this.abs.toString(),{namespaces:h.toObj()}),d.rdf.triple(this.subject.toString(),"<"+h.base()+"containedIn>",this.country.toString(),{namespaces:h.toObj()})]}}(f.vie.namespaces)}];return g},getAdditionalRules:function(f){var h={Work:"CreativeWork",Film:"Movie",TelevisionEpisode:"TVEpisode",TelevisionShow:"TVSeries",Website:"WebPage",Painting:"Painting",Sculpture:"Sculpture",Event:"Event",SportsEvent:"SportsEvent",MusicFestival:"Festival",FilmFestival:"Festival",Place:"Place",Continent:"Continent",Country:"Country",City:"City",Airport:"Airport",Station:"TrainStation",Hospital:"GovernmentBuilding",Mountain:"Mountain",BodyOfWater:"BodyOfWater",Company:"Organization",Person:"Person"};var g=[];b.each(h,function(k,j){var i={left:["?subject a dbpedia:"+j,"?subject rdfs:label ?label"],right:function(l){return function(){return[d.rdf.triple(this.subject.toString(),"a","<"+l.base()+k+">",{namespaces:l.toObj()}),d.rdf.triple(this.subject.toString(),"<"+l.base()+"name>",this.label.toString(),{namespaces:l.toObj()})]}}(f.vie.namespaces)};g.push(i)});return g}};c.prototype.Entity=function(g,h){g=(g)?g:{};h=(h)?h:{};var f=this;if(g["@type"]!==undefined){g["@type"]=(b.isArray(g["@type"]))?g["@type"]:[g["@type"]];g["@type"]=b.map(g["@type"],function(j){if(!f.vie.types.get(j)){f.vie.types.add(j).inherit("owl:Thing")}return f.vie.types.get(j).id});g["@type"]=(g["@type"].length===1)?g["@type"][0]:g["@type"]}else{g["@type"]=f.vie.types.get("owl:Thing").id}b.each(g,function(k,j){var l=c.Util.mapAttributeNS(j,this.namespaces);if(j!==l){delete g[j];g[l]=k}},f.vie);var i=e.Model.extend({idAttribute:"@subject",initialize:function(j,k){if(j["@subject"]){this.id=this["@subject"]=this.toReference(j["@subject"])}else{this.id=this["@subject"]=j["@subject"]=this.cid.replace("c","_:bnode")}return this},schema:function(){return c.Util.getFormSchema(this)},get:function(j){j=c.Util.mapAttributeNS(j,f.vie.namespaces);var k=e.Model.prototype.get.call(this,j);k=(b.isArray(k))?k:[k];k=b.map(k,function(l){if(l!==undefined&&j==="@type"&&f.vie.types.get(l)){return f.vie.types.get(l)}else{if(l!==undefined&&f.vie.entities.get(l)){return f.vie.entities.get(l)}else{return l}}},this);if(k.length===0){return undefined}k=(k.length===1)?k[0]:k;return k},has:function(j){j=c.Util.mapAttributeNS(j,f.vie.namespaces);return e.Model.prototype.has.call(this,j)},hasRelations:function(){var j=false;b.each(this.attributes,function(k){if(k&&k.isCollection){j=true}});return j},set:function(m,l,o){if(!m){return this}if(m["@subject"]){m["@subject"]=this.toReference(m["@subject"])}if(typeof m==="string"){var p={};p[m]=l;return this.set(p,o)}if(m.attributes){m=m.attributes}var j=this;var n;b.each(m,function(r,q){var s=c.Util.mapAttributeNS(q,j.vie.namespaces);if(q!==s){delete m[q];m[s]=r}},this);b.each(m,function(s,r){if(!s){return}if(r.indexOf("@")===-1){if(s.isCollection){s.each(function(u){j.vie.entities.addOrUpdate(u)})}else{if(s.isEntity){j.vie.entities.addOrUpdate(s);n=new j.vie.Collection(s,{vie:j.vie,predicate:r});m[r]=n}else{if(b.isArray(s)){if(this.attributes[r]&&this.attributes[r].isCollection){var q=this.attributes[r].addOrUpdate(s);m[r]=this.attributes[r];m[r].reset(q)}}else{if(s["@value"]){}else{if(b.isObject(s)&&!b.isDate(s)){var t=new j.vie.Entity(s,l);j.vie.entities.addOrUpdate(t);n=new j.vie.Collection(s,{vie:j.vie,predicate:r});m[r]=n}else{}}}}}}},this);var k=e.Model.prototype.set.call(this,m,l);if(l&&l.ignoreChanges){this.changed={};this._previousAttributes=b.clone(this.attributes)}return k},unset:function(j,k){j=c.Util.mapAttributeNS(j,f.vie.namespaces);return e.Model.prototype.unset.call(this,j,k)},validate:function(j,m){if(m&&m.validate===false){return}var l=this.get("@type");if(b.isArray(l)){var k=[];b.each(l,function(o){var n=this.validateByType(o,j,m);if(n){k.push(n)}},this);if(b.isEmpty(k)){return}return b.flatten(k)}return this.validateByType(l,j,m)},validateByType:function(m,k,o){var n={max:"<%= property %> cannot contain more than <%= num %> items",min:"<%= property %> must contain at least <%= num %> items",required:"<%= property %> is required"};if(!m.attributes){return}var q=function(s,t,r){return{property:s.id,constraint:t,message:b.template(n[t],b.extend({property:s.id},r))}};var j=function(s,r){if(!r[s.id]||b.isEmpty(r[s.id])){return q(s,"required",{})}};var p=function(s,r){if(!r[s.id]){return}if(!r[s.id].isCollection&&!b.isArray(r[s.id])){return}if(r[s.id].length>s.max){return q(s,"max",{num:s.max})}};var l=[];b.each(m.attributes.list(),function(s){var r;if(s.max&&s.max!=-1){r=p(s,k);if(r){l.push(r)}}if(s.min&&s.min>0){r=j(s,k);if(r){l.push(r)}}});if(b.isEmpty(l)){return}return l},isNew:function(){if(this.getSubjectUri().substr(0,7)==="_:bnode"){return true}return false},hasChanged:function(j){if(this.markedChanged){return true}return e.Model.prototype.hasChanged.call(this,j)},forceChanged:function(j){this.markedChanged=j?true:false},getSubject:function(){if(typeof this.id==="undefined"){this.id=this.attributes[this.idAttribute]}if(typeof this.id==="string"){if(this.id.substr(0,7)==="http://"||this.id.substr(0,4)==="urn:"){return this.toReference(this.id)}return this.id}return this.cid.replace("c","_:bnode")},getSubjectUri:function(){return this.fromReference(this.getSubject())},isReference:function(j){var k=new RegExp("^\\<([^\\>]*)\\>$");if(k.exec(j)){return true}return false},toReference:function(m){if(b.isArray(m)){var j=this;return b.map(m,function(n){return j.toReference(n)})}var l=this.vie.namespaces;var k=m;if(m.substring(0,2)==="_:"){k=m}else{if(l.isCurie(m)){k=l.uri(m);if(k==="<"+l.base()+m+">"){k="<"+m+">"}}else{if(!l.isUri(m)){k="<"+m+">"}}}return k},fromReference:function(k){var j=this.vie.namespaces;if(!j.isUri(k)){return k}return k.substring(1,k.length-1)},as:function(j){if(j==="JSON"){return this.toJSON()}if(j==="JSONLD"){return this.toJSONLD()}throw new Error("Unknown encoding "+j)},toJSONLD:function(){var k={};var j=this;b.each(j.attributes,function(n,m){var l=n;if(n instanceof j.vie.Collection){l=n.map(function(o){return o.getSubject()})}k[m]=l});k["@subject"]=j.getSubject();return k},setOrAdd:function(l,k,m){var j=this;if(typeof l==="string"&&k){j._setOrAddOne(l,k,m)}else{if(typeof l==="object"){b(l).each(function(o,n){j._setOrAddOne(n,o,k)})}}return this},_setOrAddOne:function(k,o,m){if(!k||!o){return}m=(m)?m:{};var l;k=c.Util.mapAttributeNS(k,f.vie.namespaces);if(b.isArray(o)){for(l=0;l<o.length;l++){this._setOrAddOne(k,o[l],m)}return}if(k==="@type"&&o instanceof f.vie.Type){o=o.id}var p={};var n=e.Model.prototype.get.call(this,k);if(!n){p[k]=o;this.set(p,m)}else{if(n.isCollection){if(o.isCollection){o.each(function(q){n.add(q)})}else{if(o.isEntity){n.add(o)}else{if(typeof o==="object"){o=new this.vie.Entity(o);n.add(o)}else{throw new Error("you cannot add a literal to a collection of entities!")}}}this.trigger("change:"+k,this,o,{});this.change({})}else{if(b.isArray(n)){if(o.isCollection){for(l=0;l<o.size();l++){this._setOrAddOne(k,o.at(l).getSubject(),m)}}else{if(o.isEntity){this._setOrAddOne(k,o.getSubject(),m)}else{if(typeof o==="object"){o=new this.vie.Entity(o);this._setOrAddOne(k,o,m)}else{n.push(o);p[k]=n;this.set(p)}}}}else{var j=[n];j.push(o);p[k]=j;return this.set(p,m)}}}},hasType:function(j){j=f.vie.types.get(j);return this.hasPropertyValue("@type",j)},hasPropertyValue:function(l,k){var j=this.get(l);if(!(k instanceof Object)){k=f.vie.entities.get(k)}if(j instanceof Array){return j.indexOf(k)!==-1}else{return j===k}},isof:function(l){var k=this.get("@type");if(k===undefined){return false}k=(b.isArray(k))?k:[k];l=(f.vie.types.get(l))?f.vie.types.get(l):new f.vie.Type(l);for(var j=0;j<k.length;j++){if(f.vie.types.get(k[j])){if(f.vie.types.get(k[j]).isof(l)){return true}}else{var m=new f.vie.Type(k[j]);if(m.id===l.id){return true}}}return false},addTo:function(k,l){var j=this;if(k instanceof j.vie.Collection){if(l){k.addOrUpdate(j)}else{k.add(j)}return this}throw new Error("Please provide a proper collection of type VIE.Collection as argument!")},isEntity:true,vie:f.vie});return new i(g,h)};c.prototype.Collection=e.Collection.extend({model:c.prototype.Entity,initialize:function(g,f){if(!f||!f.vie){throw new Error("Each collection needs a VIE reference")}this.vie=f.vie;this.predicate=f.predicate},canAdd:function(f){return true},get:function(f){if(f===null){return null}f=(f.getSubject)?f.getSubject():f;if(typeof f==="string"&&f.indexOf("_:")===0){if(f.indexOf("bnode")===2){f=f.replace("_:bnode","c");return this._byCid[f]}else{return this._byId["<"+f+">"]}}else{f=this.toReference(f);return this._byId[f]}},addOrUpdate:function(g,f){f=f||{};var k=this;var i;if(b.isArray(g)){var j=[];b.each(g,function(l){j.push(k.addOrUpdate(l,f))});return j}if(g===undefined){throw new Error("No model given")}if(b.isString(g)){g={"@subject":g,id:g}}if(!g.isEntity){g=new this.model(g)}if(g.id&&this.get(g.id)){i=this.get(g.id)}if(this.getByCid(g.cid)){i=this.getByCid(g.cid)}if(i){var h={};b.each(g.attributes,function(n,m){if(!i.has(m)){h[m]=n;return true}if(m==="@subject"){if(g.isNew()&&!i.isNew()){return true}}if(i.get(m)===n){return true}var o=i.attributes[m];var l=n;if(o instanceof k.vie.Collection){return true}if(f.overrideAttributes){h[m]=n;return true}if(m==="@context"){h[m]=d.extend(true,{},o,l)}else{o=(d.isArray(o))?o:[o];l=(d.isArray(l))?l:[l];h[m]=b.uniq(o.concat(l));h[m]=(h[m].length===1)?h[m][0]:h[m]}});if(!b.isEmpty(h)){i.set(h,f.updateOptions)}return i}this.add(g,f.addOptions);return g},isReference:function(f){var g=new RegExp("^\\<([^\\>]*)\\>$");if(g.exec(f)){return true}return false},toReference:function(f){if(this.isReference(f)){return f}return"<"+f+">"},fromReference:function(f){if(!this.isReference(f)){return f}return f.substring(1,f.length-1)},isCollection:true});if(c.prototype.Type){throw new Error("ERROR: VIE.Type is already defined. Please check your installation!")}if(c.prototype.Types){throw new Error("ERROR: VIE.Types is already defined. Please check your installation!")}c.prototype.Type=function(h,f,g){if(h===undefined||typeof h!=="string"){throw"The type constructor needs an 'id' of type string! E.g., 'Person'"}this.id=this.vie.namespaces.isUri(h)?h:this.vie.namespaces.uri(h);if(this.vie.types.get(this.id)){throw new Error("The type "+this.id+" is already defined!")}this.supertypes=new this.vie.Types();this.subtypes=new this.vie.Types();this.attributes=new this.vie.Attributes(this,(f)?f:[]);this.metadata=g?g:{};this.isof=function(i){i=this.vie.types.get(i);if(i){return i.subsumes(this.id)}else{throw new Error("No valid type given")}};this.subsumes=function(i){i=this.vie.types.get(i);if(i){if(this.id===i.id){return true}var j=this.subtypes.list();for(var l=0;l<j.length;l++){var k=j[l];if(k){if(k.id===i.id||k.subsumes(i)){return true}}}return false}else{throw new Error("No valid type given")}};this.inherit=function(j){if(typeof j==="string"){this.inherit(this.vie.types.get(j))}else{if(j instanceof this.vie.Type){j.subtypes.addOrOverwrite(this);this.supertypes.addOrOverwrite(j);try{this.attributes.list()}catch(m){j.subtypes.remove(this);this.supertypes.remove(j);throw m}}else{if(d.isArray(j)){for(var k=0,l=j.length;k<l;k++){this.inherit(j[k])}}else{throw new Error("Wrong argument in VIE.Type.inherit()")}}}return this};this.hierarchy=function(){var k={id:this.id,subtypes:[]};var j=this.subtypes.list();for(var m=0,i=j.length;m<i;m++){var l=this.vie.types.get(j[m]);k.subtypes.push(l.hierarchy())}return k};this.instance=function(j,k){j=(j)?j:{};k=(k)?k:{};if(k.typeChecking!==false){for(var i in j){if(i.indexOf("@")!==0&&!this.attributes.get(i)){throw new Error("Cannot create an instance of "+this.id+" as the type does not allow an attribute '"+i+"'!")}}}if(j["@type"]){j["@type"].push(this.id)}else{j["@type"]=this.id}return new this.vie.Entity(j,k)};this.toString=function(){return this.id}};c.prototype.Types=function(){this._types={};this.add=function(i,f,h){if(b.isArray(i)){b.each(i,function(j){this.add(j)},this);return this}if(this.get(i)){throw new Error("Type '"+i+"' already registered.")}else{if(typeof i==="string"){var g=new this.vie.Type(i,f,h);this._types[g.id]=g;return g}else{if(i instanceof this.vie.Type){this._types[i.id]=i;return i}else{throw new Error("Wrong argument to VIE.Types.add()!")}}}return this};this.addOrOverwrite=function(g,f){if(this.get(g)){this.remove(g)}return this.add(g,f)};this.get=function(g){if(!g){return undefined}if(typeof g==="string"){var f=this.vie.namespaces.isUri(g)?g:this.vie.namespaces.uri(g);return this._types[f]}else{if(g instanceof this.vie.Type){return this.get(g.id)}}return undefined};this.remove=function(j){var f=this.get(j);if(!f){return this}if(!f||f.subsumes("owl:Thing")){console.warn("You are not allowed to remove 'owl:Thing'.");return this}delete this._types[f.id];var g=f.subtypes.list();for(var i=0;i<g.length;i++){var h=g[i];if(h.supertypes.list().length===1){this.remove(h)}else{h.supertypes.remove(f.id)}}return f};this.toArray=this.list=function(){var f=[];for(var g in this._types){f.push(this._types[g])}return f};this.sort=function(i,h){var n=this;i=(d.isArray(i))?i:[i];h=(h)?true:false;if(i.length===0){return[]}var f=[i[0]];var l,g;for(l=1,g=i.length;l<g;l++){var m=i[l];var j=n.get(m);if(j){for(var k=0;k<f.length;k++){if(j.subsumes(f[k])){f.splice(k,0,m);break}else{if(k===f.length-1){f.push(m)}}}}}for(l=0;l<f.length;l++){if(f.lastIndexOf(f[l])!==l){f.splice(l,1);l--}}if(!h){f.reverse()}return f}};if(c.prototype.Attribute){throw new Error("ERROR: VIE.Attribute is already defined. Please check your VIE installation!")}if(c.prototype.Attributes){throw new Error("ERROR: VIE.Attributes is already defined. Please check your VIE installation!")}c.prototype.Attribute=function(k,f,j,h,i,g){if(k===undefined||typeof k!=="string"){throw new Error("The attribute constructor needs an 'id' of type string! E.g., 'Person'")}if(f===undefined){throw new Error("The attribute constructor of "+k+" needs 'range'.")}if(j===undefined){throw new Error("The attribute constructor of "+k+" needs a 'domain'.")}this._domain=j;this.id=this.vie.namespaces.isUri(k)?k:this.vie.namespaces.uri(k);this.range=(b.isArray(f))?f:[f];h=h?h:0;this.min=(h>0)?h:0;i=i?i:1;if(i===-1){i=Number.MAX_VALUE}this.max=(i>=this.min)?i:this.min;this.metadata=g?g:{};this.applies=function(n){if(this.vie.types.get(n)){n=this.vie.types.get(n)}for(var o=0,m=this.range.length;o<m;o++){var l=this.vie.types.get(this.range[o]);if(l===undefined&&typeof n==="string"){if(n===this.range[o]){return true}}else{if(n.isof(this.range[o])){return true}}}return false}};c.prototype.Attributes=function(g,f){this._local={};this._attributes={};this.domain=g;this.add=function(m,j,l,h,k){if(b.isArray(m)){b.each(m,function(n){this.add(n)},this);return this}if(this.get(m)){throw new Error("Attribute '"+m+"' already registered for domain "+this.domain.id+"!")}else{if(typeof m==="string"){var i=new this.vie.Attribute(m,j,this.domain,l,h,k);this._local[i.id]=i;return i}else{if(m instanceof this.vie.Attribute){m.domain=this.domain;m.vie=this.vie;this._local[m.id]=m;return m}else{throw new Error("Wrong argument to VIE.Types.add()!")}}}};this.remove=function(i){var h=this.get(i);if(h.id in this._local){delete this._local[h.id];return h}throw new Error("The attribute "+i+" is inherited and cannot be removed from the domain "+this.domain.id+"!")};this.get=function(i){if(typeof i==="string"){var h=this.vie.namespaces.isUri(i)?i:this.vie.namespaces.uri(i);return this._inherit()._attributes[h]}else{if(i instanceof this.vie.Attribute){return this.get(i.id)}else{throw new Error("Wrong argument in VIE.Attributes.get()")}}};this._inherit=function(){var D,t,A;var q=d.extend(true,{},this._local);var E=b.map(this.domain.supertypes.list(),function(p){return p.attributes});var u={};var m={};var s,l;for(D=0,s=E.length;D<s;D++){var B=E[D].list();for(t=0,l=B.length;t<l;t++){A=B[t].id;if(!(A in q)){if(!(A in u)&&!(A in m)){u[A]=B[t]}else{if(!m[A]){m[A]={range:[],mins:[],maxs:[],metadatas:[]}}if(A in u){m[A].range=d.merge(m[A].range,u[A].range);m[A].mins=d.merge(m[A].mins,[u[A].min]);m[A].maxs=d.merge(m[A].maxs,[u[A].max]);m[A].metadatas=d.merge(m[A].metadatas,[u[A].metadata]);delete u[A]}m[A].range=d.merge(m[A].range,B[t].range);m[A].mins=d.merge(m[A].mins,[B[t].min]);m[A].maxs=d.merge(m[A].maxs,[B[t].max]);m[A].metadatas=d.merge(m[A].metadatas,[B[t].metadata]);m[A].range=b.uniq(m[A].range);m[A].mins=b.uniq(m[A].mins);m[A].maxs=b.uniq(m[A].maxs);m[A].metadatas=b.uniq(m[A].metadatas)}}}}d.extend(q,u);for(A in m){var z=m[A].range;var o=m[A].mins;var n=m[A].maxs;var j=m[A].metadatas;var k=[];for(var v=0,h=z.length;v<h;v++){var y=this.vie.types.get(z[v]);var F=false;if(y){for(t=0;t<h;t++){if(t===v){continue}var C=this.vie.types.get(z[t]);if(C&&C.isof(y)){F=true;break}}}if(!F){k.push(z[v])}}var i=b.max(o);var w=b.min(n);if(i<=w&&w>=0&&i>=0){q[A]=new this.vie.Attribute(A,k,this,i,w,j[0])}else{throw new Error("This inheritance is not allowed because of an invalid minCount/maxCount pair!")}}this._attributes=q;return this};this.toArray=this.list=function(j){var k=[];var i=this._inherit()._attributes;for(var h in i){if(!j||i[h].applies(j)){k.push(i[h])}}return k};f=b.isArray(f)?f:[f];b.each(f,function(h){this.add(h.id,h.range,h.min,h.max,h.metadata)},this)};if(c.prototype.Namespaces){throw new Error("ERROR: VIE.Namespaces is already defined. Please check your VIE installation!")}c.prototype.Namespaces=function(g,f){if(!g){throw new Error("Please provide a base namespace!")}this._base=g;this._namespaces=(f)?f:{};if(typeof this._namespaces!=="object"||b.isArray(this._namespaces)){throw new Error("If you want to initialise VIE namespace prefixes, please provide a proper object!")}};c.prototype.Namespaces.prototype.base=function(f){if(!f){return this._base}else{if(typeof f==="string"){this.removeNamespace(f);this._base=f;return this._base}else{throw new Error("Please provide a valid namespace!")}}};c.prototype.Namespaces.prototype.add=function(g,f){if(typeof g==="object"){for(var h in g){this.add(h,g[h])}return this}if(g===""){this.base(f);return this}else{if(this.contains(g)&&f!==this._namespaces[g]){throw new Error("ERROR: Trying to register namespace prefix mapping ("+g+","+f+")!There is already a mapping existing: '("+g+","+this.get(g)+")'!")}else{d.each(this._namespaces,function(j,i){if(i===f&&j!==g){throw new Error("ERROR: Trying to register namespace prefix mapping ("+g+","+f+")!There is already a mapping existing: '("+j+","+f+")'!")}})}}this._namespaces[g]=f;return this};c.prototype.Namespaces.prototype.addOrReplace=function(g,f){if(typeof g==="object"){for(var h in g){this.addOrReplace(h,g[h])}return this}this.remove(g);this.removeNamespace(f);return this.add(g,f)};c.prototype.Namespaces.prototype.get=function(f){if(f===""){return this.base()}return this._namespaces[f]};c.prototype.Namespaces.prototype.getPrefix=function(f){var g;if(f.indexOf("<")===0){f=f.substring(1,f.length-1)}d.each(this._namespaces,function(i,h){if(f.indexOf(h)===0){g=i}if(f.indexOf(i+":")===0){g=i}});return g};c.prototype.Namespaces.prototype.contains=function(f){return(f in this._namespaces)};c.prototype.Namespaces.prototype.containsNamespace=function(f){return this.getPrefix(f)!==undefined};c.prototype.Namespaces.prototype.update=function(g,f){this.remove(g);return this.add(g,f)};c.prototype.Namespaces.prototype.updateNamespace=function(g,f){this.removeNamespace(g);return this.add(g,f)};c.prototype.Namespaces.prototype.remove=function(f){if(f){delete this._namespaces[f]}return this};c.prototype.Namespaces.prototype.removeNamespace=function(f){var g=this.getPrefix(f);if(g){delete this._namespaces[g]}return this};c.prototype.Namespaces.prototype.toObj=function(f){if(f){return d.extend({},this._namespaces)}return d.extend({"":this._base},this._namespaces)};c.prototype.Namespaces.prototype.curie=function(f,g){return c.Util.toCurie(f,g,this)};c.prototype.Namespaces.prototype.isCurie=function(f){return c.Util.isCurie(f,this)};c.prototype.Namespaces.prototype.uri=function(f){return c.Util.toUri(f,this)};c.prototype.Namespaces.prototype.isUri=c.Util.isUri})();